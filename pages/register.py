import os
import re
import sys
import time
import hashlib
import streamlit as st
from oauth2client.service_account import ServiceAccountCredentials
from googleapiclient.discovery import build
from datetime import datetime
from dotenv import load_dotenv
# sys.modules['sqlite3'] = sys.modules.pop('pysqlite3')
load_dotenv()

st.set_page_config(page_title="Ricefit API (Register)", layout="wide")

# st.sidebar.page_link('app.py', label='Home')
st.sidebar.page_link('pages/getting_started.py', label='Getting Started')

st.sidebar.page_link('pages/register.py', label='Register')

def validate_email(email):
    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    if not re.match(pattern, email):
        return False, "Please enter a valid email address"
    return True, ""


def validate_phone(phone):
    pattern = r'^\d{9,10}$'
    if not re.match(pattern, phone):
        return False, "Please enter a valid phone number"
    return True, ""

def recording_submition(data):
    try : 
        scope = ['https://www.googleapis.com/auth/spreadsheets']
        credentials = ServiceAccountCredentials.from_json_keyfile_dict(os.environ["GOOGLE_APPLICATION_CREDENTIALS"], scope)
        spreadsheet_id = '1_YHFcF6DJ74AyshIW7iGzku1u30vBfCSQU2kD2bDuIc'

        rows = [
            [str(v) for k, v in data.items()],
        ]
        service = build('sheets', 'v4', credentials=credentials)
        service.spreadsheets().values().append(
            spreadsheetId=spreadsheet_id,
            range="A:Z",
            body={
                "majorDimension": "ROWS",
                "values": rows
            },
            valueInputOption="USER_ENTERED"
        ).execute()
                    
    except Exception as e:
        print(f"[recording_submition] ERROR: {e}", file=sys.stderr, flush=True)


st.title("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô API")

with st.form("register_form"):
    col1, col2 = st.columns(2)

    # ------------- LEFT COLUMN -------------
    with col1:
        first_name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠")
        last_name = st.text_input("‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•")

        email = st.text_input("‡∏≠‡∏µ‡πÄ‡∏°‡∏•")
        if email:
            is_valid, message = validate_email(email)
            if not is_valid:
                st.error(message)

        mobile = st.text_input("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠")
        if mobile:
            is_valid, message = validate_phone(mobile)
            if not is_valid:
                st.error(message)

    # ------------- RIGHT COLUMN -------------
    with col2:
        occupation = st.selectbox(
            "‡∏≠‡∏≤‡∏ä‡∏µ‡∏û",
            [
                "‡∏ô‡∏±‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏≠‡∏¥‡∏™‡∏£‡∏∞",
                "‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
                "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£/‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô",
                "‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£/‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏±‡∏ê",
            ],
        )
        organization = st.text_input("‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô")
        location = st.text_input("‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á")
        org_type = st.selectbox(
            "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô",
            [
                "‡πÉ‡∏ô‡∏ô‡∏≤‡∏°‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•",
                "‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
                "‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£/‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô",
                "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏±‡∏ê",
                "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®",
            ],
        )
        phone = st.text_input("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô)")
        purpose = st.text_area("‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå")

    submitted = st.form_submit_button("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")

# ======================
# Submit Logic
# ======================
if submitted:
    # Validate all fields
    validations = [
        validate_email(email),
        validate_phone(mobile),
    ]

    # Check if all validations pass
    if all(v[0] for v in validations):
        st.success("Form submitted successfully!")
        # Update session state
        recording_submition({
            "first_name": first_name,
            "last_name": last_name,
            "email": email,
            "mobile": mobile,
            "occupation": occupation,
            "organization": organization,
            "location": location,
            "org_type": org_type,
            "phone": phone,
            "purpose": purpose,
            "created_at": datetime.now().isoformat(),
            'submitted': True
        })
        
        st.toast("üéâ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", icon="üéâ")
        time.sleep(1.2)      # ‡πÉ‡∏´‡πâ popup ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡πà‡∏≠‡∏ô
        st.rerun()


